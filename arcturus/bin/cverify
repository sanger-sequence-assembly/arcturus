#!/usr/local/bin/perl -w

#############################################################################
# Upload Contigs into ARCTURUS database
#############################################################################

use strict; # Constraint variables declaration before using them

use DBI; # Perl DB Interface module
use ConfigReader::MyCgi;   
use ConfigReader::Simpleton; # Module for managing configuration information
use Scripts::MyHTML;
use TableReader::DbaseTable;
use TableReader::ArcturusTable;
use TableReader::ContigBuilder;
use TableReader::ReadMapper;
# use TableReader::ReadsReader;

# use Compress::Compress;

##############################################################################
# unbuffered output
##############################################################################

open(STDERR,">&STDOUT") || die "Can't dump to STDOUT: $!\n";
select(STDERR); $| = 1; # Make unbuffered.
select(STDOUT); $| = 1; # Make unbuffered.

# print "content-type: text/html\n\n";

##############################################################################
# Loading Configuration Parameters
##############################################################################

# Get configuration parameters using Configuration File ".arc_common.cnf"

my $CONFIG_DIR = '/nfs/team81/ejz/arcturus/scripts/ConfigReader';
my $config = ConfigReader::Simpleton->new ("$CONFIG_DIR/.arc_common.cnf") ||
            die "No such file or directory: $CONFIG_DIR/.arc_common.cnf";
$config->parse ();

##############################################################################
# how is this script invoked?
##############################################################################

my $origin = 1; # default CGI
$origin = 0 if (!$ENV{PATH_INFO}); # from command line
my @brtag = ('\n','<br>'); 

##############################################################################
# open MySQL Reads Database
##############################################################################

my $driver      = $config->get("db_driver");
my $db_name     = $config->get("mysql_database");
my $host        = $config->get("mysql_hostname");
my $username    = $config->get("mysql_username");
my $password    = $config->get("mysql_password");

my $USERSUPPORT = $config->get("USERSUPPORT");
my $db_manager  = $config->get("db_manager");      

# check whether this driver is available

my @drivers = DBI->available_drivers;
#print "\nDrivers : @drivers\n\n";

my $lg = @drivers + 0;
my $i = 0;
while (($i < $lg) && ($driver ne $drivers[$i])) {
  $i ++;
}
if ($i >= $lg) {
  print STDERR "Driver syntax incorrect or Driver, $driver,  non available - install it before ...\n";
  exit 1;
}

# data source name

my $dsn = "DBI:".$driver.":".$db_name.":".$host;

print "\n\nHERE WE GO (dsn: $dsn)\n\n" if !$origin;

print "Trying to open database $db_name ..." if !$origin;
my $dbh = DBI->connect($dsn, $username, $password, {RaiseError => 1 }) 
        or die "! Failed to access $db_name again: $DBI::errstr";
print "... DONE\n\n" if !$origin;

##############################################################################
# Some local parameters and variables
##############################################################################

my %config;
$config{CDD} = $config->get('ROOTDIR');  # root data dir for caf files
$config{CFN} = 'MAL<m>.<n>.caf';         # name of individual caf file
$config{CNF} = '';                       # name filter
$config{CGN} = '';                       # generation number
$config{CPR} = 1000;                     # default maximum nr. contigs to load

my $arc_cgi_dir  = $config->get('ARC_CGI_DIR');
my $arc_log_dir  = $config->get('ARC_LOG_DIR');

$config{CLF} = "$arc_log_dir/cloader.DATABASE.log"; # default logfile

my ($userid, $database, $caffile, $cgi, $page);
my ($left, $list, $exactmatch);
my ($TEST, $logON, $reload, $update);
my ($CDD, $CFN, $CNF, $CGN, $CPR, $CLF);
my ($assembly, $assemblyname, $assemblynmbr);
my ($projects, $projectname, $projectnmbr);

my $return    = "$arc_cgi_dir/update/arcturus/getmenu";

my ($brtag, $gfont, $yfont, $ofont, $rfont, $efont);

###############################################################################

my $organisms = TableReader::ArcturusTable->new($dbh,'ORGANISMS','arcturus',1);
my $users = $organisms->new($dbh,'USERS','arcturus',1);

if (!$origin) {
    $brtag = "\n";
###############################################################################
# test user
###############################################################################
    $userid = $ENV{USER};
    if ($userid ne 'ejz' && $userid ne 'adh') {
# test against the priviledges for this user
        die "User $userid does not have priviledge to run 'cloader' from".
            "the command line.\nTry the web-based version";
    }
###############################################################################
# Test command line parameters
###############################################################################
# input: ARGV[0]: database name

    if (@ARGV < 1) {
        print STDERR "! specify a database [assemblyname, [projectname]]\n";
        $dbh->disconnect;
        exit 1;
    }

# get file name filter and global (directory) filter 

    $database = $ARGV[0];
    my $onumber = $organisms->associate('number',$database,'dbasename');
    die "Organism database $database does not exist\n" if !$onumber;

    $assemblyname = $ARGV[1];
    $projectname  = $ARGV[2];

# open assembly and project tables

    $assembly = $organisms->new($dbh,'ASSEMBLY',$database,0);
    die "$assembly->{errors}\n" if $assembly->{errors};
    $projects = $organisms->new($dbh,'PROJECTS',$database,0);
    die "$projects->{errors}\n" if $projects->{errors};

# determine the default assemblyname if none is given

    if (!$assemblyname) {
	my $where = "assemblyname like '%BLOB%' and organism=$onumber";
        $assemblyname = $assembly->associate('assemblyname','where',$where);
        die "No default assembly available for database $database\n" if !$assemblyname;
    }
    $assemblynmbr = $assembly->associate('assembly',$assemblyname,'assemblyname');
    die "No such assembly $assemblyname exists for database $database\n" if !$assemblynmbr;

# determine the default project name if none is given

    if (!$projectname) {
	my $where = "projecttype='Bin' and assembly=$assemblynmbr";
        $projectname = $projects->associate('projectname','where',$where);
        die "No default project available for for assembly $assemblyname\n" if !$projectname;
    }
    $projectnmbr = $projects->associate('project',$projectname,'projectname');
    die "No such project $projectname exists for assembly $assemblyname\n" if !$projectnmbr;

    print "Contigs will be allocated to assembly $assemblyname (nr $assemblynmbr)\n";
    print "and project $projectname (nr $projectnmbr)\n";

$TEST = 1;
}

else {
# invoked as CGI scripts
    die 'Not yet prepared for CGI version';
    $brtag = "<br>";
    $gfont = "<FONT COLOR=lightgreen>";
    $yfont = "<FONT COLOR=yellow>";
    $ofont = "<FONT COLOR=orange>";
    $rfont = "<FONT COLOR=red>";
    $efont = "</FONT>";

   (my $void,$database,my $option) = split ('/',$ENV{PATH_INFO});

    $cgi = ConfigReader::MyCgi->new(); # parse CGI
    $cgi->PrintHeader(1); # print the magic words 

    $option = 'process' if ($option eq 'specify' && $cgi->parameter('process',0));

    $page = Scripts::MyHTML->new('ARCTURUS CONTIGs loader');    
    $page->address('ejz@sanger.ac.uk','Ed Zuiderwijk',2);
    $page->frameborder(100,15,'white',10);
    $page->center(1);

    undef my $error;
    if ($option eq 'getform') {
# 
        $page->form("$arc_cgi_dir/cloader/arcturus/specify");
        $page->partition(2);
        $page->sectionheader("ARCTURUS assembly database: CONTIGs loader specifications",3,0);
        $page->partition(1);
        my $count = $organisms->count();
        $page->sectionheader("There are $count Organism databases",3,0);
        $page->add($organisms->htmlTable('0110000011100000')); # list them
        my $select =  $organisms->htmlOptions('dbasename','database',20);
        $page->sectionheader("Select a Database : $select",4,0);
        $page->sectionheader("Provide your User Identification and Submit",4,0);
        $page->identify('10',8,1);
        $page->partition(5);
        $page->center(1);
        $page->submitbuttonbar("$arc_cgi_dir/update/arcturus/getmenu",0,0,'MAIN MENU');
        $page->form(0);
        $page->flush();
        $dbh->disconnect;
        exit 0;
    }

    elsif ($option eq 'specify') {
# list all assemblies
        $database  = $cgi->parameter('database'); # compulsory
        my $userid = $cgi->parameter('identify'); # compulsory
        my $passwd = $cgi->parameter('password'); # compulsory
        my $asname = $cgi->parameter('assemblyname',0); # no test
        $asname = 0 if !$asname; # to have it explicitly defined

        $page->form("$arc_cgi_dir/cloader/arcturus/specify");
        $page->partition(2);
        $page->sectionheader("ARCTURUS assembly database '$database': CONTIGs loader specifications",3,0);
        $page->partition(1);

        if ($cgi->{und_error} || !$database) {
            $page->errorbox("Please define all form entries");
            $page->add($cgi->PrintVariables());
        }
        else {
    # open assembly database; abort if no assemblies defined
            $assembly  = TableReader::ArcturusTable->new($dbh,'ASSEMBLY',$database,1);
            if ($assembly && $assembly->count() > 0) {
            # get the default assembly name if no assemblyname in CGI input; first try attributes
                my $attributes = $organisms->unpackAttributes($database,'dbasename');
                $asname = $attributes->{anlast} if (!$asname && $attributes->{anlast});
            # if still undefined, just take the first one
                $asname = $assembly->{hashrefs}->[0]->{assemblyname} if (!$asname);
            # substitute (possible) database placeholder
                $config{CLF} =~ s/DATABASE/$database/; # log file
            # overwrite the preset configuration data with those in ORGANISM attributes if any
                foreach my $key (keys %config) {
                    $config{$key} = $attributes->{$key} if defined($attributes->{$key});
# print "ORGANISM attribute $key  = $config{$key}<br>" if defined($attributes->{$key});
                }
            # overwrite the preset configuration data with those in ASSEMBLY attributes if any
                $attributes = $assembly->unpackAttributes($asname,'assemblyname');
                foreach my $key (keys %config) {
                    $config{$key} = $attributes->{$key} if defined($attributes->{$key});
# print "ASSEMBLY attribute $key  = $config{$key}<br>" if defined($attributes->{$key});
                }
            # update the caf file name if it contains a place holder
                $config{CFN} =~ s/^\S+?(\<m\>|\d+)/$asname/;
            # open the form and replace the placeholders
                my $form = form();
                $form =~ s/DATABASE/$database/g;
            # build the select list and add to form
                my $selectlist = $assembly->htmlOptions('assemblyname','assemblyname',100,0,$asname);
                $form =~ s/SELECTTAG/$selectlist/ if ($selectlist); # substitute the HTML selectlist
                $page->add($form,0,1); # add the form to the page and preload
            # preload the remaining placeholders with data in %config 
                foreach my $key (keys %config) {
                    $page->preload($key,$config{$key},1) if defined($config{$key});
                }
            # but overwrite with values in CGI input 
                $page->preload('cgi_input',$cgi,1);
            # and add hidden fields  
                $page->ingestCGI($cgi);

            # add a three-way button bar and a return link 

                my $text = "Repeat to update this form for a newly chosen assembly, or<br>";
                $text   .= "Continue to start loading CONTIGS with these specified values, or<br>";
                $text   .= "Click on the return link to the main UPDATE menu<br>";
                $page->sectionheader($text,4,0);
                my @buttons = ('type=submit value=" Repeat "',
                               'type=submit value="Continue" name="process"',
                               'type=reset  value=" Reset "');
                $page->buttonbartemplate(3,0,\@buttons);                 
                $page->linkbutton('RETURN',$return,0);
            }
            else {
                $page->errorbox("There are no assemblies defined for $database",0,0,'yellow');
                $page->messagebox("Please contact $db_manager or your project manager",$return);
            }
        }
    # close form
        $page->form(0);
        $page->flush();
        $dbh->disconnect;
        exit 0;
    }

    elsif ($option eq 'process') {
    # get assembly 
        $database = $cgi->parameter('database'); # redefine database
        $assembly = $organisms->new($dbh,'ASSEMBLY',$database,1);
        $assemblyname = $cgi->parameter('assemblyname'); # translate into number
        $assemblynmbr = $assembly->associate('assembly',$assemblyname,'assemblyname');

        $projects = $organisms->new($dbh,"PROJECTS",$database,1);

        $CPR = $cgi->parameter('CPR');
    # test mode
        $TEST   = 1 if $cgi->parameter('testrun',0);
        $logON  = 1 if $cgi->parameter('logON'  ,0);
        $reload = 1 if $cgi->parameter('reload' ,0);
        $update = 1 if $cgi->parameter('update', 0);
    # identity check
        $userid = $cgi->parameter('identify');
        my $passwd = $cgi->parameter('password');
      
        if ($cgi->{und_error}) {
            $error = "Please define every input field $cgi->{und_error} ";
        }
        elsif (my $users = $organisms->new($dbh,'USERS','arcturus',1)) {
    # authorisation level 100 required (temp)
            if (my $status = $users->authorize($userid,$passwd,100)) {
                $error = $status; # authorisation failed
            }
    # okay, now get specifications
            else {
                $CDD = $cgi->parameter('CDD');
                $CFN = $cgi->parameter('CFN');
                $CNF = $cgi->parameter('CNF');
                $CGN = $cgi->parameter('CGN');
                $CPR = $cgi->parameter('CPR');
                $CLF = $cgi->parameter('CLF');
            }
#            $arc_logfile = $cgi->parameter('LGF') if ($logON);
        }
        else {
            $error = "Can't access the USERS table in ARCTURUS database";
        }
    }
    else {
        $error = "Invalid option $option for cloader";
    }

# abort on any error, else continue with the main script

    if ($error) {
        $page->partition(2);
        $page->sectionheader("ARCTURUS CONTIGs loader specifications",3,0);
        $page->partition(1);
        $page->sectionheader("Sorry, an error status aborts this loader session",3,1);
        $page->errorbox($error,$return);
        $page->flush();
        $dbh->disconnect;
        exit 0;
    }
#    $page->add($cgi->PrintVariables());
}

###############################################################################
# open all database tables required
###############################################################################

    my $dbreads  = $organisms->new($dbh,"READS",$database,0);
    my $rrtoaa   = $organisms->new($dbh,"READS2ASSEMBLY",$database,0);
    my $contigs  = $organisms->new($dbh,"CONTIGS",$database,0);
    my $cctocc   = $organisms->new($dbh,"CONTIGS2CONTIG",$database,0);
    my $rrtocc   = $organisms->new($dbh,"READS2CONTIG",$database,0);
    my $cctopp   = $organisms->new($dbh,"CONTIGS2SCAFFOLD",$database,0);
    my $pptoaa   = $organisms->new($dbh,"PROJECTS2ASSEMBLY",$database,0);
    my $cltocc   = $organisms->new($dbh,"CLONES2CONTIG",$database,0);
    my $cltopp   = $organisms->new($dbh,"CLONES2PROJECT",$database,0);

###############################################################################
# Strategy: 1 Scan CONTIGS and CONTIGS2SCAFFOLD; assign missing links to current
#           defaults (which actually might be incorrect, i.e wrong data in C2P)
#           2 Scan CONTIGS, READS, READS2CONTIG to get a) CLONES2CONTIG
#                                                      b) CLONES2PROJECT
#                                                      c) READS2ASSEMBLY
#
###############################################################################
# Test if all contigs in the database are assigned to an assembly
###############################################################################

    my $query = "use $database";
    $organisms->query($query,0,0);

    print "Scanning database $database for contigs of generation 0 ....";
# - collect from READS2CONTIG, get creation date window and test if no others 

    $query  = "select distinct contig_id from <self> where generation=0";
    my $contigids = $rrtocc->query($query,0,0);

    undef my @dbcontigs;
    if (ref($contigids) =~ /ARRAY/) {
        foreach my $contighash (@$contigids) {
            my $contig = $contighash->{contig_id};
            push @dbcontigs, $contig if $contig;
        }
        undef @$contigids; # free memory 
    }
    my $nrc = @dbcontigs;
    print "... DONE$brtag$nrc contigs found$brtag$brtag";
    print "! $contigs->{qerror}$brtag" if !$contigids;
     
# for each contig, test the number of reads against the value in CONTIGS

    foreach my $contigid (sort @$contigids) {

        print "Testing contig $contigid .. ";
        my $hashref = $contigs->associate('hashref',$contigid,'contig_id');

        my $alias  = $hashref->{aliasname};
        my $nreads = $hashref->{nreads};
        my $ncntgs = $hashref->{ncntgs};
        my $cover  = $hashref->{cover};
        my $length = $hashref->{cover};
        print "$alias $hashref->{contigname} $brtag";

# test number of reads in READS2CONTIG

        my $reads = $rrtocc->associate('read_id','distinct where','contig_id=$contigid');
        if (ref($reads) eq 'ARRAY') {
            my $nr = @$reads;
            print "mismatch of number of reads in $alias: $nreads  vs. $nr $brtag" if ($nreads != $nr);
        }
        else {
            print "mismatch of number of reads in $alias: $nreads  vs. $reads $brtag" if ($nreads != $reads);
        }

# test cover and length

        $query  = "select min(pcstart) as psmin, max(pcstart) as psmax, min(pcfinal) as pfmin, ";
	$query .= "max(pcfinal) as pfmax, sum(prfinal - prstart) as sum ";
        $query .= "from <self> where contig_id = $contigid";
        my $hash = $rrtocc->query($query,0,0);
        my $l1 = $hash->{pfmax} - $hash->{psmin}; # read going with contig
        my $l2 = $hash->{psmax} - $hash->{pfmin}; # read against contig
        if ($length != $l1 && $length != $l2) {
            print "mismatch of length $length: $l1 or $l2 $brtag";
        }
        
    }


print STDOUT "Closing database$brtag$brtag";
$dbh->disconnect;
exit 0;


##############################################################################
# subroutines
##############################################################################

sub form {
    my $source = shift;

    my $form;

    $form  = "<TABLE BORDER=0 CELLSPACING=2 CELLPADDING=2 WIDTH 100%>";

    $form .= "<TR><TH ALIGN=LEFT>Root Data Directory</TH>";
    $form .= "<TD COLSPAN=2><INPUT NAME='CDD' SIZE=32 MAXSIZE=64 VALUE=''></TD></TR>";

    $form .= "<TR><TH ALIGN=LEFT>CAF File Name</TH>";
    $form .= "<TD COLSPAN=2><INPUT NAME='CFN' SIZE=32 MAXSIZE=64 VALUE=''></TD></TR>";

    $form .= "<TR><TH ALIGN=LEFT>Contig Name Filter</TH>";
    $form .= "<TD><INPUT NAME='CNF' SIZE=16 MAXSIZE=64 VALUE=''></TD>";
    $form .= "<TD>&nbsp</TD></TR>";

    $form .= "<TR><TH ALIGN=LEFT>Generation</TH>";
    $form .= "<TD><INPUT NAME='CGN' SIZE=5 VALUE=''></TD>";
    $form .= "<TD>&nbsp</TD></TR>";

    $form .= "<TR><TH ALIGN=LEFT>DATABASE Assembly Name</TH><TD>SELECTTAG</TD>";
    $form .= "<TD>&nbsp</TD></TR>";

    $form .= "<TR><TH ALIGN=LEFT> Load a maximum of </TH>";
    $form .= "<TD><INPUT VALUE='1000' SIZE=5 NAME='CPR'> contigs </TD></TR>";
#   $form .= "<TD><b>Check</b> <INPUT type=checkbox name=forceload> for FORCED load </TD></TR>";

    $form .= "<TR><TH ALIGN=LEFT>Check <INPUT type=checkbox name=logON checked> for log file</TH>";
    $form .= "<TD COLSPAN=2><INPUT NAME='CLF' SIZE=32 MAXSIZE=64 VALUE=''></TD></TR>";

#    $form .= "<TR><TH AKIGN=LEFT>Check <INPUT type=checkbox name=testrun> for TEST run </TH>";
    $form .= "<TR><TH AKIGN=LEFT>Check <INPUT type=checkbox name=testrun checked> for TEST run </TH>";
    $form .= "<TH ALIGN=RIGHT COLSPAN=2> Check <INPUT type=checkbox name=update> for update of defaults </TH></TR>";
    $form .= "</TABLE>";

    return $form;
}
